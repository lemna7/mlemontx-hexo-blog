---
title: 微信&支付宝支付
date: 2023/04/20
tags:
  - Java
categories:
  - 技术
  - Java
---

## 一、信息安全基础

### 1.1 机密性

机密性是信息安全的基础，实现机密性最常用的手段就是加密。

明文(plain text) -> 通过密钥(key保密)和加密算法(公开)进行加密(encrypt)-> 密文(cipher text)-> 通过密钥(key保密)和解密算法(公开)来解密(decrypt) -> 明文(plain text)

密钥的度量单位是位 bit，如，密钥长度128，就是16字节的二进制串。

按照密钥的使用方式，加密可以分为两大类：对称加密和非对称加密。

#### 1.1.1 对称加密

指加密、解密的时候使用的密钥是同一个，是对称的，只要保证密钥的安全性，那整个通信过程就具有了机密性，因为通信过程中传输的全是用密钥加密后的密文，所以只有消息的发送方和接收方才能解密。即使消息被窃取，看到的也是加密后的密文，因为没有密钥无法接触明文，所以就实现了发送消息的机密性。

对称加密的算法：
 - AES加密算法，密钥长度128、192或256，安全强度高，性能很好。 

加密分组模式：将明文分组加密，微信支付中使用 AEAD_AES_256_GCM，AES_256意思就是256个长度的AES非对称加密算法，AEAD GCM就是分组模式当中的具体分组算法。

#### 1.1.2 非对称加密

非对称加密有两个密钥，一个公钥(public key)、一个私钥(private key)，两个密钥是不同的，所以叫非对称。

公钥可以公开给任何人使用，私钥必须是严格保密。

使用公钥加密后只能使用私钥解密，使用私钥加密后，也只能使用公钥解密。

非对称加密的算法：
  - RSA加密算法，最著名的非对称加密算法，微信中使用的非对称算法使用的就是这种方式。

#### 1.1.3 对称加密和非对称加密的优缺点

对称加密：
  - 优点：运算速度快。
  - 缺点：密钥需要信息交换的双方共享，一旦被窃取，消息会被破解。

非对称加密：
  - 优点：私钥严格保密，公钥任意分发，黑客获取公钥无法破解密文。
  - 缺点：运算速度非常慢。

怎么结合，我们可以用非对称加密的方式先传输对称加密需要的密钥，这样可以保证密钥被安全的传递，后期的信息交换过程就可以安全的使用对称加密了，https协议使用的就是这个原理。

### 1.2 身份认证

私钥加密公钥加密的过程其实就是身份认证的过程。

例如Bob有两把钥匙，公钥和私钥，他把公钥送给他的朋友们Susan。
Susan给Bob写信，他用Bob的公钥加密发送给Bob，Bob使用自己的私钥解密就可以看到。
Bob想要给Susan写信怎么办呢，那她也需要公钥和私钥，再把公钥送给她的朋友们，那Bob写信用Susan的公钥加密，发给Susan，Susan用自己的私钥解密就可以看到了。
这些都是用公钥加密，私钥解密，如果我们反过来，私钥加密，公钥解密，有什么作用呢？
Bob给Susan写信，用自己的私钥进行加密，但是Bob的朋友都有他的公钥，因此他们都能够解密Bob的信，所以我们发现私钥加密、公钥解密并不是为了加密，所以它到底有什么用呢？
Bob使用自己的私钥对信件加密，Susan必须使用Bob的公钥对信件进行解密，因此Susan能够确认的是这封信是Bob发的，而不是别人，
所以，私钥加密，公钥加密的作用其实就是身份认证。

### 1.3 数字签名

信件不需要加密，如何保证信件不被篡改，即信息的完整性？

实现信息完整性的手段主要是摘要算法(Digest Algorithm)，也就是常说的散列函数、哈希函数(Hash Function)。

如任意长度的字符串Z，经过哈希运算得到固定长度的字符串H，就是Z的哈希结果，又称为数据指纹、摘要（MD5就是一个非常典型的加密算法）。

摘要算法的特性：
  1. 不可逆性：只有算法，没有密钥，只能加密，不能解密。
  2. 难题友好型：想要破解，只能暴力破解。
  3. 发散性：只要对原文进行一点点改动，摘要就会发生剧烈变化。
  4. 抗碰撞性：原文不同，计算后的摘要也要不同，防止哈希冲突。

常见的摘要算法：MD5、SHA1、SHA2(SHA224、SHA256、SHA384)，MD5和SHA1不具有强的抗碰撞性。

RSA2 标准算法名称 SHA256WithRSA

1、RSA非对称加密技术

2、SHA256 是SHA-2下细分出的一种算法

SHA-2，名称来自于安全散列算法2（英语：Secure Hash Algorithm 2）的缩写，一种密码散列函数算法标准，由美国国家安全局研发，属于SHA算法之一，是SHA-1的后继者。

摘要算法的作用：保证信息的完整性。

但，不能保证摘要可信任。

Bob写完信之后先用摘要算法生成原信件的摘要，Bob将摘要附在信件原文的下面，一起发送个Pat。
Pat收到信之后也是用跟Bob一样的摘要算法对原文进行加密，然后跟Bob的摘要进行对比，如果一直则没有被篡改，否则被篡改。

摘要算法不具有机密性，如果信件被黑客截取，黑客更改原信件再更改附件摘要，Pat则无法察觉。

Bob写信用摘要算法加密，然后用自己的私钥对摘要进行加密，加密后的结果我们称为`数字签名`，Bob将数字签名附在原文下面发给Pat。
Pat取下数字签名，用Bob的公钥进行解密，Pat使用和Bob一样的摘要算法加密信件的原文，得到信件的摘要，Pat将摘要进行比对，如果一致则完整，这个过程我们叫做`验签`。

数字签名可以保证信息传递的过程中不可以被篡改，以及信息传递者的身份的认证。

公钥存在信任问题。

### 1.4 数字证书

数字证书解决公钥信任问题。

Doug想要欺骗Pat，他将自己的公钥发送给Pat，谎称这是Bob的公钥，那Pat就会误以为自己和Bob通信，实际上在跟Doug通信。

公钥的信任：黑客可以伪造公钥，怎么判断公钥是真实的？
**数字证书**

数字证书中的信息：
  - 公钥：Bob的公钥
  - 所有者：Bob
  - 颁发者：CA(Certificate Authority)，证书颁发机构，第三方机构防止被伪造
  - 有效期：证书的使用期限
  - 签名哈希算法：指定摘要算法，用来计算证书的摘要
  - 指纹：证书的摘要，保证证书的完整性
  - 签名算法：用于生成签名，确保证书是由CA签发
  - 序列号：证书的唯一标识

CA用证书中指定的哈希算法计算出证书的摘要，也就是指纹，CA根据证书中的签名算法，用CA自己的私钥进行加密，生成证书的签名，最后将证书的签名和证书的基本信息一起发布，Bob就得到了数字证书。
Bob给Pat写信，在签名的同时再附上数字证书就可以了，Pat收到信，取出数字证书，验签数字证书，Pat用证书的Hash算法根据证书信息计算整个摘要，使用CA的公钥从数字证书的签名中解析出数字证书的摘要，对比，验签没问题之后，Pat取出公钥。
最信件验证，用证书的摘要算法加密出摘要，再用数字证书的Bob公钥对信件进行解密，比对摘要，验签通过则没有任何问题。

### 1.5 https协议

主要用于网页加密，https网站向CA申请证书，CA颁发数字证书(CA用私钥加密数字证书并签名，数字证书中存在网站的公钥)，
浏览器向网站发出了加密请求，网站对网页进行加密会连同数字证书一起发送给客户端浏览器。
浏览器获取网站公钥，使用CA的公钥解密数字证书并验签，CA的公钥默认安装在操作系统中，判断网址与证书中的网址是否一致，是不是权威机构颁发的证书。
数字证书可靠，客户端就可以获取网站公钥，再使用网站的公钥信息进行加密，然后与网站进行通信。

## 二、微信支付（无商户号）

> [微信支付官网](https://pay.weixin.qq.com/)

### 2.1 微信支付产品

1. 付款码支付
2. JSAPI支付
3. 小程序支付
4. Native支付
5. APP支付
6. 刷脸支付

**由于无商户号暂不做研究，日后补充。**

## 三、支付宝支付

> [支付宝开放平台](https://open.alipay.com/)

### 3.1 电脑网站支付

#### 3.3.1 接入准备

常规接入流程（企业）：

创建应用、绑定应用、配置密钥、上线应用、签约功能。

创建应用步骤：
1. 登录
2. 网页/移动应用开发
3. 创建应用
4. 开发设置
5. 设置接口加签方式（密钥/证书）
6. 设置接口内容加密方式

下一步需要商家账号，故之后再做。

沙箱接入流程（测试）：

直接使用沙箱提供的开发参数，无需进行应用的创建、绑定、上线和签约。

### 3.2 沙箱接入

#### 3.2.1 沙箱参数获取

需要配置的参数：

1. APPID：2021000122630934
2. 绑定的商家账号（PID）：2088621997111281
3. 应用私钥
4. 支付宝公钥
5. 支付宝网关地址
6. 接口内容加密方式

支付宝账号：

商家信息：要配置商家的PID，应用里已有。
买家信息：当支付的时候选择用买家的账号密码登录和支付。

#### 3.2.2 









